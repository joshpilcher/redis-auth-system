{% extends "base.html" %}
{% block title %}Forgot Password{% endblock %}

<!--
Purpose: Handles the multi-step password reset process.
Steps:
  1. Collect email address
  2. Ask security question
  3. Reset password (with show/hide toggle)
Includes:
  - Forms for each step (POST to forgot_password route)
  - Password input toggle using base.html script
-->

{% block content %}
<div class="card mt-5">
    <div class="card-header text-center">
        <h3><i class="fas fa-key"></i> Forgot Password</h3>
    </div>

    <div class="card-body p-4">
        {% if step == 1 %}
        <!-- Step 1: Enter email -->
        <form method="POST" action="{{ url_for('forgot_password') }}">
            <input type="hidden" name="step" value="1">
            <p class="text-muted">Enter your email address to reset your password.</p>
            <div class="mb-4">
                <label for="email" class="form-label"><i class="fas fa-envelope"></i> Email Address</label>
                <input type="email" class="form-control" id="email" name="email" required autofocus>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary"><i class="fas fa-arrow-right"></i> Continue</button>
            </div>
        </form>

        {% elif step == 2 %}
        <!-- Step 2: Answer security question -->
        <form method="POST" action="{{ url_for('forgot_password') }}">
            <input type="hidden" name="step" value="2">
            <p class="text-muted mb-3">Answer your security question to verify your identity.</p>
            <div class="alert alert-info"><i class="fas fa-question-circle"></i> {{ question }}</div>
            <div class="mb-4">
                <label for="answer" class="form-label"><i class="fas fa-shield-alt"></i> Your Answer</label>
                <input type="text" class="form-control" id="answer" name="answer" required autofocus>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> Verify Answer</button>
            </div>
        </form>

        {% elif step == 3 %}
        <!-- Step 3: Reset password -->
        <form method="POST" action="{{ url_for('forgot_password') }}">
            <input type="hidden" name="step" value="3">
            <p class="text-muted">Create a new password for your account.</p>

            <!-- New password -->
            <div class="mb-3">
                <label for="password" class="form-label"><i class="fas fa-lock"></i> New Password</label>
                <div class="input-with-icon">
                    <input type="password" class="form-control" id="password" name="password" required
                        autocomplete="new-password" minlength="8">
                    <button class="password-btn" type="button" id="togglePassword" aria-label="Show password"
                        data-bs-toggle="tooltip" data-bs-placement="left" title="Show password">
                        <svg class="icon-20" aria-hidden="true" focusable="false">
                            <use id="togglePasswordIconUse" href="#bi-eye-slash"></use>
                        </svg>
                    </button>
                </div>
                <small class="form-text text-muted">At least 8 characters</small>
            </div>

            <!-- Confirm password -->
            <div class="mb-4">
                <label for="confirm_password" class="form-label"><i class="fas fa-lock"></i> Confirm Password</label>
                <div class="input-with-icon">
                    <input type="password" class="form-control" id="confirm_password" name="confirm_password" required
                        autocomplete="new-password" minlength="8">
                    <button class="password-btn" type="button" id="toggleConfirm" aria-label="Show password"
                        data-bs-toggle="tooltip" data-bs-placement="left" title="Show password">
                        <svg class="icon-20" aria-hidden="true" focusable="false">
                            <use id="toggleConfirmIconUse" href="#bi-eye-slash"></use>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="d-grid">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Reset Password</button>
            </div>
        </form>
        {% endif %}

        <!-- Back to login link -->
        <div class="text-center mt-3">
            <a href="{{ url_for('login') }}">Back to Login</a>
        </div>
    </div>
</div>
{% endblock %}
